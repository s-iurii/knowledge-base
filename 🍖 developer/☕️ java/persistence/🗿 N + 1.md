
#### –ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ–±–ª–µ–º–∞ N + 1

–ü—Ä–æ–±–ª–µ–º–∞ N + 1 –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç N –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Ö –∂–µ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–¥–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞.

–ß–µ–º –±–æ–ª—å—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ N, —Ç–µ–º –±–æ–ª—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∏ —Ç–µ–º –±–æ–ª—å—à–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å. –ò —Ö–æ—Ç—è¬†[–ª–æ–≥ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤](https://vladmihalcea.com/hibernate-slow-query-log/)¬†–º–æ–∂–µ—Ç –≤–∞–º –ø–æ–º–æ—á—å –Ω–∞–π—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–æ –ø—Ä–æ–±–ª–µ–º—É N + 1 –æ–Ω –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏—Ç, —Ç–∞–∫ –∫–∞–∫ –∫–∞–∂–¥—ã–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä–æ.¬†

–ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤ —Å—É–º–º–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –≤–ª–∏—è—é—â–µ–µ –Ω–∞ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏–µ.

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ë–î: post (–ø–æ—Å—Ç—ã) –∏ post_comments (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç–∞–º), –∫–æ—Ç–æ—Ä—ã–µ —Å–≤—è–∑–∞–Ω—ã –æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º¬†"–æ–¥–∏–Ω-–∫–æ-–º–Ω–æ–≥–∏–º".

–ö–∞–∫ —É–∂–µ –≥–æ–≤–æ—Ä–∏–ª–æ—Å—å, –ø—Ä–æ–±–ª–µ–º–∞ N + 1 –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ª—é–±–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º, –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä—è–º–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ SQL.

–ï—Å–ª–∏ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ¬†`post_comments`¬†—Å –ø–æ–º–æ—â—å—é —Å–ª–µ–¥—É—é—â–µ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞:

```
List<Tuple> comments = entityManager.createNativeQuery("""    SELECT        pc.id AS id,        pc.review AS review,        pc.post_id AS postId    FROM post_comment pc    """, Tuple.class).getResultList();
```

–ê –ø–æ–∑–∂–µ —Ä–µ—à–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ (title) —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ (post) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (post_comment):

```
for (Tuple comment : comments) {    String review = (String) comment.get("review");    Long postId = ((Number) comment.get("postId")).longValue();     String postTitle = (String) entityManager.createNativeQuery("""        SELECT            p.title        FROM post p        WHERE p.id = :postId        """)    .setParameter("postId", postId)    .getSingleResult();     LOGGER.info(        "The Post '{}' got this review '{}'",        postTitle,        review    );}
```

–í—ã –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É N + 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ SQL-–∑–∞–ø—Ä–æ—Å–∞ –≤—ã –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –ø—è—Ç—å (1 + 4):

```sql
SELECT    
pc.id AS id,    
pc.review AS review,    
pc.post_id AS postIdFROM post_comment pc 

SELECT p.title FROM post p WHERE p.id = 1-- The Post 'High-Performance Java Persistence - Part 1' got this review-- 'Excellent book to understand Java Persistence'    
SELECT p.title FROM post p WHERE p.id = 2-- The Post 'High-Performance Java Persistence - Part 2' got this review-- 'Must-read for Java developers'     
SELECT p.title FROM post p WHERE p.id = 3-- The Post 'High-Performance Java Persistence - Part 3' got this review-- 'Five Stars'     
SELECT p.title FROM post p WHERE p.id = 4-- The Post 'High-Performance Java Persistence - Part 4' got this review-- 'A great reference book'
```

#### N+1 in JPA
[[üå≥ JPA]]
##### join fetch

https://habr.com/ru/companies/otus/articles/529692/

–û–ø—è—Ç—å –∂–µ, —Ä–µ—à–µ–Ω–∏–µ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏¬†`JOIN FETCH`¬†–∫ –∑–∞–ø—Ä–æ—Å—É¬†`JPQL`:
```sql

List<PostComment> comments = entityManager.createQuery(
" select pc 
	from PostComment pc 
  join fetch pc.post p ", PostComment.class) .getResultList(); 
  
  for(PostComment comment : comments) { 
	  LOGGER.info( "The Post '{}' got this review '{}'", comment.getPost().getTitle(), comment.getReview() ); }

```
–ò –∫–∞–∫ –∏ –≤ –ø—Ä–∏–º–µ—Ä–µ —Å¬†`FetchType.EAGER`, —ç—Ç–æ—Ç JPQL-–∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å.

–î–∞–∂–µ –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ¬†`FetchType.LAZY`¬†–∏ –Ω–µ —Å—Å—ã–ª–∞–µ—Ç–µ—Å—å –Ω–∞ –¥–æ—á–µ—Ä–Ω–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è¬†`@OneToOne`, –≤—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å N + 1.

–ø—Ä–∏–º–µ—Ä—ã:
```java
@Query("SELECT a FROM Author a JOIN FETCH a.books") List<Author> findAllWithBooks();
```


##### use Set
https://www.baeldung.com/spring-hibernate-n1-problem

–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–æ–π–¥–µ–º –∫ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ-–¥—Ä—É–≥–æ–º—É. –î–∞–≤–∞–π—Ç–µ –∑–∞–º–µ–Ω–∏–º¬†_Lists_¬†–Ω–∞¬†_Sets_¬†. –ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂–∞–¥–Ω—É—é –≤—ã–±–æ—Ä–∫—É, —Ç–∞–∫ –∫–∞–∫ –ª–µ–Ω–∏–≤—ã–µ¬†_Sets_¬†–∏¬†_List_¬†–≤–µ–¥—É—Ç —Å–µ–±—è —Å—Ö–æ–∂–∏–º –æ–±—Ä–∞–∑–æ–º:

```java
@Entity
public class Group {
    @Id
    private Long id;
    private String name;
    @ManyToMany(fetch = FetchType.EAGER)
    private Set<User> members;
    // constructors, getters, setters, etc.
}

@Entity
public class User {
    @Id
    private Long id;
    private String username;
    private String email;
    @OneToMany(cascade = CascadeType.ALL, mappedBy = "author", fetch = FetchType.EAGER)
    protected Set<Post> posts;
    // constructors, getters, setters, etc.
}
@Entity
public class Post {
    @Id
    private Long id;
    @Lob
    private String content;
    @ManyToOne
    private User author;
    // constructors, getters, setters, etc.
}
```

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ–¥–µ–º –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞:


@NamedEntityGraph
https://medium.com/@kiarash.shamaii/what-is-n-1-query-generate-problem-in-spring-data-jpa-and-how-to-solve-it-2f3b9f1a7a0b

–ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ—ã —Å—É—â–Ω–æ—Å—Ç–µ–π –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –≤ –∫–ª–∞—Å—Å–∞—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π —Å –ø–æ–º–æ—â—å—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –∏ –º–æ–≥—É—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö. –í–æ—Ç –ø—Ä–∏–º–µ—Ä:

```java
@Entity   
@NamedEntityGraph (   
    name = "Book.author" ,   
    attributeNodes = @NamedAttributeNode ( "author" )   
)   
public class Book {   
    // ...  
 }

@EntityGraph(value = "Book.author", type = EntityGraph.EntityGraphType.FETCH) List<Book> findAll();
 ```


–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –≥—Ä–∞—Ñ—ã —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ–∑–≤–æ–ª—è—é—Ç –≤–∞–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–ª–∞–Ω –≤—ã–±–æ—Ä–∫–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é API¬†`javax.persistence.EntityGraph`. –í–æ—Ç –ø—Ä–∏–º–µ—Ä:

```java
@Repository  
 –æ—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å BookRepository —Ä–∞—Å—à–∏—Ä—è–µ—Ç JpaRepository<Book, Long> {   
    @Query ( "SELECT b FROM Book b WHERE b.genre = :genre" )   
    ‚Äã‚ÄãList<Book> findByGenre ( @Param ( "genre" ) ‚Äã‚ÄãString genre, EntityGraph entityGraph);   
}
```


–í –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º –≤—ã—à–µ –ø—Ä–∏–º–µ—Ä–µ –º—ã –ø–µ—Ä–µ–¥–∞–µ–º¬†`EntityGraph`–æ–±—ä–µ–∫—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ –º–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä¬†`EntityGraph`–∏ —É–∫–∞–∑–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏–∑–≤–ª–µ–∫–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.

–í –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º –≤—ã—à–µ –ø—Ä–∏–º–µ—Ä–µ –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ —Å—É—â–Ω–æ—Å—Ç–µ–π —Å –∏–º–µ–Ω–µ–º ¬´Book.author¬ª, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –∞—Ç—Ä–∏–±—É—Ç ¬´author¬ª, –ø–æ–¥–ª–µ–∂–∞—â–∏–π –≤—ã–±–æ—Ä–∫–µ.

```java
@EntityGraph(attributePaths = {"books"}) 
List<Author> findAll();
```

##### use DTO
: –î—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã N+1 ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ü–∏–∏ DTO (Data Transfer Object) –≤–º–µ—Å—Ç–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–æ–ª–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π. –°–æ–∑–¥–∞–≤ DTO, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–Ω—É–∂–Ω—ã—Ö –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π. –≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–µ–Ω, –∫–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–Ω–æ –∏–∑–≤–ª–µ—á—å –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–≥–¥–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã.

```java

public  interface  BookProjection {   
    String getTitle () ;   
    AuthorProjection getAuthor () ;   
}   
  
public  interface  AuthorProjection {   
    String getName () ;   
}   
  
@Repository   
public  interface  BookRepository  extends  JpaRepository < Book , Long > {   
    List<BookProjection> findAllProjectedBy () ;   
}
```
–í –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–º –≤—ã—à–µ –ø—Ä–∏–º–µ—Ä–µ –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–≤–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–æ–µ–∫—Ü–∏–∏,¬†`BookProjection`–∏¬†`AuthorProjection`, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –ø–æ–ª—è.¬†`findAllProjectedBy()`–ú–µ—Ç–æ–¥ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫¬†`BookProjection`—ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è.